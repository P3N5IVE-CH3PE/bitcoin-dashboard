<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Nowcasting Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(to bottom right, #111827, #1f2937, #111827); color: white; min-height: 100vh; padding: 1rem; }
        .container { max-width: 1280px; margin: 0 auto; }
        .header { margin-bottom: 1.5rem; }
        .header-top { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
        h1 { font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .subtitle { color: #9CA3AF; font-size: 0.875rem; }
        .btn { display: flex; align-items: center; gap: 0.5rem; background-color: #ea580c; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer; font-size: 0.875rem; transition: all 0.2s; }
        .btn:hover { background-color: #c2410c; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .card { background-color: #1f2937; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); border: 1px solid #374151; }
        .price-card { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1.5rem; }
        .price-display { font-size: 2.5rem; font-weight: bold; color: #fb923c; }
        .price-change { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem; font-size: 1.25rem; font-weight: 600; }
        .signal-badge { padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }
        .signal-badge.buy { background-color: #16a34a; }
        .signal-badge.sell { background-color: #dc2626; }
        .signal-badge.neutral { background-color: #4b5563; }
        .timeframe-container { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; }
        .timeframe-btn { padding: 0.5rem 0.75rem; background-color: #374151; border: none; border-radius: 0.375rem; color: white; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .timeframe-btn:hover { background-color: #4b5563; transform: translateY(-2px); }
        .timeframe-btn.active { background-color: #ea580c; transform: scale(1.05); }
        .grid { display: grid; gap: 1.5rem; margin-bottom: 1.5rem; }
        .grid-2 { grid-template-columns: 1fr; }
        .grid-4 { grid-template-columns: repeat(2, 1fr); }
        .grid-signals { grid-template-columns: 1fr; }
        @media (min-width: 768px) { .grid-signals { grid-template-columns: repeat(2, 1fr); } .grid-4 { grid-template-columns: repeat(4, 1fr); } }
        @media (min-width: 1024px) { .grid-2 { grid-template-columns: repeat(2, 1fr); } .grid-signals { grid-template-columns: repeat(3, 1fr); } }
        .chart-container { height: 300px; position: relative; }
        .stat-card { background-color: #1f2937; border: 1px solid #374151; border-radius: 0.5rem; padding: 1rem; }
        .stat-label { color: #9CA3AF; font-size: 0.75rem; margin-bottom: 0.25rem; }
        .stat-value { font-size: 1.25rem; font-weight: bold; }
        .signal-card { border-radius: 0.5rem; padding: 1rem; border: 2px solid; transition: transform 0.2s; }
        .signal-card:hover { transform: scale(1.05); }
        .signal-bullish { color: #4ade80; background-color: #14532d; border-color: #16a34a; }
        .signal-bearish { color: #f87171; background-color: #7f1d1d; border-color: #dc2626; }
        .signal-caution { color: #fbbf24; background-color: #78350f; border-color: #d97706; }
        .signal-neutral { color: #9ca3af; background-color: #374151; border-color: #6b7280; }
        .signal-normal { color: #60a5fa; background-color: #1e3a8a; border-color: #3b82f6; }
        .signal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .signal-name { font-weight: 600; }
        .signal-status { font-size: 0.75rem; font-weight: bold; }
        .signal-strength { font-size: 0.75rem; opacity: 0.8; margin-bottom: 0.25rem; }
        .signal-desc { font-size: 0.875rem; opacity: 0.9; }
        .info-box { background-color: rgba(30, 58, 138, 0.3); border: 2px solid #3b82f6; border-radius: 0.5rem; padding: 1.25rem; margin-top: 1.5rem; }
        .info-box-content { display: flex; align-items: start; gap: 0.75rem; }
        .info-title { color: #93c5fd; font-weight: 600; font-size: 1.125rem; margin-bottom: 0.5rem; }
        .info-text { font-size: 0.875rem; color: #d1d5db; line-height: 1.625; }
        .footer { margin-top: 2rem; text-align: center; color: #6b7280; font-size: 0.875rem; }
        .error-message { background-color: #78350f; border: 1px solid #d97706; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem; color: #fef3c7; }
        .loading { display: flex; align-items: center; justify-content: center; padding: 5rem 0; }
        .loading-content { text-align: center; }
        .spinner { width: 48px; height: 48px; margin: 0 auto 1rem; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none; }
        .text-green { color: #22c55e; }
        .text-red { color: #ef4444; }
        .text-orange { color: #fb923c; }
        .text-blue { color: #60a5fa; }
        .text-yellow { color: #fbbf24; }
        .text-gray { color: #9ca3af; }
        .section-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .last-update { color: #6b7280; font-size: 0.75rem; margin-top: 0.5rem; }
        @media (max-width: 640px) { h1 { font-size: 1.5rem; } .price-display { font-size: 2rem; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div>
                    <h1><svg class="text-orange" width="40" height="40" fill="currentColor" viewBox="0 0 24 24"><path d="M13 2L3 14h8l-1 8 10-12h-8l1-8z"/></svg>Bitcoin Nowcasting Dashboard</h1>
                    <p class="subtitle">Real-time market intelligence detecting change as it happens</p>
                </div>
                <button onclick="fetchData()" id="refreshBtn" class="btn"><svg id="refreshIcon" width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>Refresh</button>
            </div>
            <p id="lastUpdate" class="last-update"></p>
        </div>
        <div id="errorMsg" class="error-message hidden"><p></p></div>
        <div id="loading" class="loading">
            <div class="loading-content">
                <svg class="spinner text-orange" fill="currentColor" viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                <p style="font-size: 1.25rem; color: #9ca3af;">Loading Bitcoin data...</p>
            </div>
        </div>
        <div id="content" class="hidden">
            <div class="card">
                <div class="price-card">
                    <div>
                        <p class="text-gray" style="font-size: 0.875rem; margin-bottom: 0.25rem;">Bitcoin Price (USD)</p>
                        <p id="btcPrice" class="price-display">$0</p>
                        <div class="price-change">
                            <svg id="priceIcon" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"></svg>
                            <span id="priceChange">0%</span>
                            <span id="timeframeLabel" class="text-gray" style="font-size: 0.875rem;">24h</span>
                        </div>
                    </div>
                    <div id="overallSignal" class="signal-badge neutral">
                        <p style="font-size: 0.875rem; opacity: 0.8; margin-bottom: 0.25rem;">Overall Signal</p>
                        <p id="signalText" style="font-size: 1.875rem; font-weight: bold;">NEUTRAL</p>
                    </div>
                </div>
            </div>
            <div class="card">
                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.75rem;">Select Timeframe</h3>
                <div class="timeframe-container">
                    <button onclick="changeTimeframe(event, '1m', '1 Minute')" class="timeframe-btn">1m</button>
                    <button onclick="changeTimeframe(event, '5m', '5 Minutes')" class="timeframe-btn">5m</button>
                    <button onclick="changeTimeframe(event, '15m', '15 Minutes')" class="timeframe-btn">15m</button>
                    <button onclick="changeTimeframe(event, '1h', '1 Hour')" class="timeframe-btn">1h</button>
                    <button onclick="changeTimeframe(event, '4h', '4 Hours')" class="timeframe-btn">4h</button>
                    <button onclick="changeTimeframe(event, '1d', '1 Day')" class="timeframe-btn active">1D</button>
                    <button onclick="changeTimeframe(event, '1w', '1 Week')" class="timeframe-btn">1W</button>
                    <button onclick="changeTimeframe(event, '1M', '1 Month')" class="timeframe-btn">1M</button>
                    <button onclick="changeTimeframe(event, '3M', '3 Months')" class="timeframe-btn">3M</button>
                    <button onclick="changeTimeframe(event, '6M', '6 Months')" class="timeframe-btn">6M</button>
                    <button onclick="changeTimeframe(event, '1y', '1 Year')" class="timeframe-btn">1Y</button>
                    <button onclick="changeTimeframe(event, '5y', '5 Years')" class="timeframe-btn">5Y</button>
                    <button onclick="changeTimeframe(event, 'max', 'All Time')" class="timeframe-btn">ALL</button>
                </div>
            </div>
            <div class="grid grid-2">
                <div class="card">
                    <h3 class="section-title" style="font-size: 1.25rem;">Price History - <span id="chartTitle">1 Day</span></h3>
                    <div class="chart-container"><canvas id="priceChart"></canvas></div>
                </div>
                <div class="card">
                    <h3 class="section-title" style="font-size: 1.25rem;">Trading Volume</h3>
                    <div class="chart-container"><canvas id="volumeChart"></canvas></div>
                </div>
            </div>
            <div class="grid grid-4">
                <div class="stat-card"><p class="stat-label">Period High</p><p id="periodHigh" class="stat-value text-green">-</p></div>
                <div class="stat-card"><p class="stat-label">Period Low</p><p id="periodLow" class="stat-value text-red">-</p></div>
                <div class="stat-card"><p class="stat-label">Average Price</p><p id="avgPrice" class="stat-value text-blue">-</p></div>
                <div class="stat-card"><p class="stat-label">Volatility</p><p id="volatility" class="stat-value text-yellow">-</p></div>
            </div>
            <div class="card">
                <h3 class="section-title"><svg class="text-yellow" width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M13 2L3 14h8l-1 8 10-12h-8l1-8z"/></svg>Nowcasting Signals</h3>
                <div id="signalsGrid" class="grid grid-signals"></div>
            </div>
            <div class="info-box">
                <div class="info-box-content">
                    <svg style="color: #60a5fa; flex-shrink: 0; margin-top: 0.25rem;" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                    <div><h4 class="info-title">How This Works</h4><p class="info-text">This dashboard uses <strong>nowcasting principles</strong> to detect market changes as they happen across multiple timeframes. Select different periods (from minutes to all-time) to analyze Bitcoin's behavior at various scales. Signals adapt to each timeframe to show what's happening <em>right now</em> at that scale.</p></div>
                </div>
            </div>
            <div class="footer">
                <p>Data updates automatically - Powered by CoinGecko API</p>
                <p style="margin-top: 0.5rem;">Not financial advice. Educational purposes only.</p>
            </div>
        </div>
    </div>
    <script>
// Wrap all logic in IIFE to avoid global scope pollution
(function() {
    let priceChart, volumeChart;
    let currentTimeframe = '1d', currentTimeframeLabel = '1 Day';
    
    // Extracted constants for signal thresholds (replaces magic numbers)
    const SIGNAL_THRESHOLDS = {
        MOMENTUM_MODERATE: 1,
        MOMENTUM_STRONG: 2,
        VOLUME_SURGE: 1.3,
        VOLUME_DECLINE: 0.7,
        TREND_STRENGTH: 5,
        VOLATILITY_HIGH: 15,
        VOLATILITY_LOW: 5,
        MARKET_STRUCTURE: 0.02
    };

    const timeframeConfig = {
        '1m':{days:1,interval:'minutely',label:'1 Minute',dataPoints:1440},
        '5m':{days:1,interval:'minutely',label:'5 Minutes',dataPoints:288},
        '15m':{days:1,interval:'minutely',label:'15 Minutes',dataPoints:96},
        '1h':{days:7,interval:'hourly',label:'1 Hour',dataPoints:168},
        '4h':{days:30,interval:'hourly',label:'4 Hours',dataPoints:180},
        '1d':{days:30,interval:'daily',label:'1 Day',dataPoints:30},
        '1w':{days:90,interval:'daily',label:'1 Week',dataPoints:13},
        '1M':{days:365,interval:'daily',label:'1 Month',dataPoints:12},
        '3M':{days:365,interval:'daily',label:'3 Months',dataPoints:52},
        '6M':{days:365,interval:'daily',label:'6 Months',dataPoints:52},
        '1y':{days:365,interval:'daily',label:'1 Year',dataPoints:365},
        '5y':{days:1825,interval:'daily',label:'5 Years',dataPoints:365},
        'max':{days:'max',interval:'daily',label:'All Time',dataPoints:500}
    };

    // Retry logic for failed API calls (max 2 retries)
    async function fetchWithRetry(url, retries = 2) {
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
            return await response.json();
        } catch (err) {
            if (retries > 0) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                return fetchWithRetry(url, retries - 1);
            }
            throw err;
        }
    }

    // Fixed: Explicit event parameter instead of global event object
    function changeTimeframe(event, tf,lbl){
        currentTimeframe = tf;
        currentTimeframeLabel = lbl;
        document.querySelectorAll('.timeframe-btn').forEach(function(b){
            b.classList.remove('active')
        });
        event.target.classList.add('active');
        document.getElementById('chartTitle').textContent = lbl;
        document.getElementById('timeframeLabel').textContent = lbl;
        fetchData();
    }

    async function fetchData() {
        const cfg = timeframeConfig[currentTimeframe];
        const refreshBtn = document.getElementById('refreshBtn');
        const refreshIcon = document.getElementById('refreshIcon');
        const errorMsgEl = document.getElementById('errorMsg');
        const errorMsgText = errorMsgEl.querySelector('p');
        
        // Reset states
        refreshBtn.disabled = true;
        refreshIcon.style.animation = 'spin 1s linear infinite';
        errorMsgEl.classList.add('hidden');
        errorMsgText.textContent = '';

        try {
            // Fixed: Parallelize API calls for faster load times
            const [priceData, chartData] = await Promise.all([
                fetchWithRetry('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true'),
                fetchWithRetry(`https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=\({cfg.days}&interval=\){cfg.interval}`)
            ]);

            // Fixed: Input validation to prevent crashes from bad API data
            if (!priceData?.bitcoin?.usd) throw new Error("Invalid price data received from API");
            if (!chartData?.prices || !chartData?.total_volumes) throw new Error("Invalid chart data received from API");

            const prices = chartData.prices;
            const firstPrice = prices[0][1];
            const lastPrice = prices[prices.length - 1][1];
            const priceChange = ((lastPrice - firstPrice) / firstPrice) * 100;

            updateUI(priceData.bitcoin.usd, priceChange, chartData);
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
            document.getElementById('lastUpdate').textContent = 'Last updated: ' + new Date().toLocaleTimeString();

        } catch (e) {
            console.error('Fetch error:', e);
            errorMsgEl.classList.remove('hidden');
            // Fixed: Show specific error message instead of generic
            errorMsgText.textContent = `Failed to load data: ${e.message}. Please try again.`;
        } finally {
            refreshBtn.disabled = false;
            refreshIcon.style.animation = '';
        }
    }

    function updateUI(price, priceChange, historyData) {
        document.getElementById('btcPrice').textContent = '$' + price.toLocaleString();
        
        const priceChangeEl = document.getElementById('priceChange');
        priceChangeEl.textContent = (priceChange >= 0 ? '+' : '') + priceChange.toFixed(2) + '%';
        priceChangeEl.className = 'price-change ' + (priceChange >= 0 ? 'text-green' : 'text-red');
        
        const priceIconEl = document.getElementById('priceIcon');
        if (priceChange >= 0) {
            priceIconEl.innerHTML = '<path d="M7 14l5-5 5 5z"/>';
            priceIconEl.className = 'text-green';
        } else {
            priceIconEl.innerHTML = '<path d="M7 10l5 5 5-5z"/>';
            priceIconEl.className = 'text-red';
        }

        const prices = historyData.prices;
        const volumes = historyData.total_volumes;
        const formattedData = formatDataByTimeframe(prices, volumes);
        
        const priceValues = formattedData.map(d => d.price);
        const periodHigh = Math.max.apply(null, priceValues);
        const periodLow = Math.min.apply(null, priceValues);
        const avgPrice = priceValues.reduce((a,b) => a + b, 0) / priceValues.length;
        const volatility = ((periodHigh - periodLow) / periodLow * 100).toFixed(2);

        document.getElementById('periodHigh').textContent = '$' + periodHigh.toLocaleString();
        document.getElementById('periodLow').textContent = '$' + periodLow.toLocaleString();
        document.getElementById('avgPrice').textContent = '$' + Math.round(avgPrice).toLocaleString();
        document.getElementById('volatility').textContent = volatility + '%';

        generateSignals(priceChange, priceValues, formattedData.map(d => d.volume));
        updateCharts(formattedData);
    }

    function formatDataByTimeframe(prices, volumes) {
        const cfg = timeframeConfig[currentTimeframe];
        const step = Math.max(1, Math.floor(prices.length / cfg.dataPoints));
        const formatted = [];

        for (let i = 0; i < prices.length; i += step) {
            const date = new Date(prices[i][0]);
            let label;

            if (currentTimeframe.includes('m') || currentTimeframe.includes('h')) {
                label = date.toLocaleString('en-US', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'});
            } else if (currentTimeframe === '1y' || currentTimeframe === '5y' || currentTimeframe === 'max') {
                label = date.toLocaleDateString('en-US', {year: 'numeric', month: 'short'});
            } else {
                label = date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
            }

            formatted.push({
                date: label,
                price: Math.round(prices[i][1]),
                volume: volumes[i] ? Math.round(volumes[i][1] / 1000000) : 0
            });
        }

        return formatted;
    }

    function generateSignals(priceChange, priceValues, volumeValues) {
        const signals = [];
        let bullishScore = 0;
        let bearishScore = 0;

        // Adjust momentum threshold based on timeframe granularity
        const momentumThreshold = currentTimeframe.includes('m') 
            ? SIGNAL_THRESHOLDS.MOMENTUM_MODERATE * 0.5 
            : currentTimeframe.includes('h') 
                ? SIGNAL_THRESHOLDS.MOMENTUM_MODERATE 
                : SIGNAL_THRESHOLDS.MOMENTUM_MODERATE * 2;

        // 1. Price Momentum Signal
        if (priceChange > momentumThreshold * SIGNAL_THRESHOLDS.MOMENTUM_STRONG) {
            signals.push({name: 'Price Momentum', status: 'BULLISH', strength: 'Strong', desc: 'Strong upward momentum'});
            bullishScore += 2;
        } else if (priceChange > momentumThreshold) {
            signals.push({name: 'Price Momentum', status: 'BULLISH', strength: 'Moderate', desc: 'Moderate upward momentum'});
            bullishScore += 1;
        } else if (priceChange < -momentumThreshold * SIGNAL_THRESHOLDS.MOMENTUM_STRONG) {
            signals.push({name: 'Price Momentum', status: 'BEARISH', strength: 'Strong', desc: 'Strong downward momentum'});
            bearishScore += 2;
        } else if (priceChange < -momentumThreshold) {
            signals.push({name: 'Price Momentum', status: 'BEARISH', strength: 'Moderate', desc: 'Moderate downward momentum'});
            bearishScore += 1;
        } else {
            signals.push({name: 'Price Momentum', status: 'NEUTRAL', strength: 'Weak', desc: 'Consolidating'});
        }

        // 2. Volume Activity Signal
        if (volumeValues.length >= 7) {
            const recentVolumeAvg = volumeValues.slice(-3).reduce((a,b) => a + b, 0) / 3;
            const priorVolumeAvg = volumeValues.slice(Math.max(0, volumeValues.length - 10), -3).reduce((a,b) => a + b, 0) / 7;

            if (recentVolumeAvg > priorVolumeAvg * SIGNAL_THRESHOLDS.VOLUME_SURGE) {
                signals.push({name: 'Volume Surge', status: 'BULLISH', strength: 'Strong', desc: 'Accumulation detected'});
                bullishScore += 2;
            } else if (recentVolumeAvg < priorVolumeAvg * SIGNAL_THRESHOLDS.VOLUME_DECLINE) {
                signals.push({name: 'Volume Decline', status: 'BEARISH', strength: 'Moderate', desc: 'Low participation'});
                bearishScore += 1;
            } else {
                signals.push({name: 'Volume', status: 'NEUTRAL', strength: 'Normal', desc: 'Normal activity'});
            }
        }

        // 3. Trend Strength Signal
        const thirdLength = Math.floor(priceValues.length / 3);
        const recentAvgPrice = priceValues.slice(-thirdLength).reduce((a,b) => a + b, 0) / thirdLength;
        const overallAvgPrice = priceValues.reduce((a,b) => a + b, 0) / priceValues.length;
        const trendDelta = ((recentAvgPrice - overallAvgPrice) / overallAvgPrice) * 100;

        if (trendDelta > SIGNAL_THRESHOLDS.TREND_STRENGTH) {
            signals.push({name: 'Trend Strength', status: 'BULLISH', strength: 'Strong', desc: 'Strong uptrend'});
            bullishScore += 2;
        } else if (trendDelta < -SIGNAL_THRESHOLDS.TREND_STRENGTH) {
            signals.push({name: 'Trend Strength', status: 'BEARISH', strength: 'Strong', desc: 'Strong downtrend'});
            bearishScore += 2;
        } else {
            signals.push({name: 'Trend', status: 'NEUTRAL', strength: 'Weak', desc: 'Range-bound'});
        }

        // 4. Volatility Signal
        const recentPrices = priceValues.slice(-Math.min(priceValues.length, 20));
        const recentVolatility = ((Math.max.apply(null, recentPrices) - Math.min.apply(null, recentPrices)) / Math.min.apply(null, recentPrices)) * 100;

        if (recentVolatility > SIGNAL_THRESHOLDS.VOLATILITY_HIGH) {
            signals.push({name: 'High Volatility', status: 'CAUTION', strength: 'High', desc: 'Trade carefully'});
            bearishScore += 1;
        } else if (recentVolatility < SIGNAL_THRESHOLDS.VOLATILITY_LOW) {
            signals.push({name: 'Low Volatility', status: 'NEUTRAL', strength: 'Low', desc: 'Big move coming'});
        } else {
            signals.push({name: 'Volatility', status: 'NORMAL', strength: 'Normal', desc: 'Normal volatility'});
        }

        // 5. Market Structure Signal
        const quarterLength = Math.floor(priceValues.length / 4);
        const recentHigh = Math.max.apply(null, priceValues.slice(-quarterLength));
        const priorHigh = Math.max.apply(null, priceValues.slice(-quarterLength * 2, -quarterLength));

        if (recentHigh > priorHigh * (1 + SIGNAL_THRESHOLDS.MARKET_STRUCTURE)) {
            signals.push({name: 'Market Structure', status: 'BULLISH', strength: 'Strong', desc: 'Higher highs'});
            bullishScore += 1;
        } else if (recentHigh < priorHigh * (1 - SIGNAL_THRESHOLDS.MARKET_STRUCTURE)) {
            signals.push({name: 'Market Structure', status: 'BEARISH', strength: 'Strong', desc: 'Lower highs'});
            bearishScore += 1;
        } else {
            signals.push({name: 'Market Structure', status: 'NEUTRAL', strength: 'Normal', desc: 'Sideways'});
        }

        // Calculate overall signal
        let overallSignal = 'NEUTRAL';
        if (bullishScore > bearishScore + 2) overallSignal = 'STRONG BUY';
        else if (bullishScore > bearishScore) overallSignal = 'BUY';
        else if (bearishScore > bullishScore + 2) overallSignal = 'STRONG SELL';
        else if (bearishScore > bullishScore) overallSignal = 'SELL';

        updateSignals(signals, overallSignal);
    }

    // Fixed: Replaced innerHTML with DOM methods to eliminate XSS risk
    function createSignalCard(signal, classMap) {
        const card = document.createElement('div');
        card.className = `signal-card ${classMap[signal.status]}`;

        const header = document.createElement('div');
        header.className = 'signal-header';

        const nameEl = document.createElement('h4');
        nameEl.className = 'signal-name';
        nameEl.textContent = signal.name;

        const statusEl = document.createElement('span');
        statusEl.className = 'signal-status';
        statusEl.textContent = signal.status;

        header.append(nameEl, statusEl);

        const strengthEl = document.createElement('p');
        strengthEl.className = 'signal-strength';
        strengthEl.textContent = `Strength: ${signal.strength}`;

        const descEl = document.createElement('p');
        descEl.className = 'signal-desc';
        descEl.textContent = signal.desc;

        card.append(header, strengthEl, descEl);
        return card;
    }

    function updateSignals(signals, overallSignal) {
        const classMap = {
            BULLISH: 'signal-bullish',
            BEARISH: 'signal-bearish',
            CAUTION: 'signal-caution',
            NEUTRAL: 'signal-neutral',
            NORMAL: 'signal-normal'
        };

        const signalsGrid = document.getElementById('signalsGrid');
        signalsGrid.innerHTML = '';

        signals.forEach(signal => {
            signalsGrid.appendChild(createSignalCard(signal, classMap));
        });

        const overallSignalEl = document.getElementById('overallSignal');
        const signalClass = overallSignal.includes('BUY') ? 'buy' : overallSignal.includes('SELL') ? 'sell' : 'neutral';
        
        overallSignalEl.className = `signal-badge ${signalClass}`;
        document.getElementById('signalText').textContent = overallSignal;
    }

    // Fixed: Optimized chart updates (no more destroy/recreate)
    function updateCharts(data) {
        const labels = data.map(d => d.date);
        const prices = data.map(d => d.price);
        const volumes = data.map(d => d.volume);

        // Update or initialize price chart
        if (priceChart) {
            priceChart.data.labels = labels;
            priceChart.data.datasets[0].data = prices;
            priceChart.update('none');
        } else {
            const ctx1 = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Price (USD)',
                        data: prices,
                        borderColor: '#fb923c',
                        backgroundColor: 'rgba(251, 146, 60, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(c) { return '$' + c.parsed.y.toLocaleString() }
                            }
                        }
                    },
                    scales: {
                        y: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } },
                        x: { ticks: { color: '#9ca3af', maxRotation: 45, minRotation: 45 }, grid: { color: '#374151' } }
                    }
                }
            });
        }

        // Update or initialize volume chart
        if (volumeChart) {
            volumeChart.data.labels = labels;
            volumeChart.data.datasets[0].data = volumes;
            volumeChart.update('none');
        } else {
            const ctx2 = document.getElementById('volumeChart').getContext('2d');
            volumeChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Volume (M)',
                        data: volumes,
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(c) { return c.parsed.y.toLocaleString() + 'M' }
                            }
                        }
                    },
                    scales: {
                        y: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } },
                        x: { ticks: { color: '#9ca3af', maxRotation: 45, minRotation: 45 }, grid: { color: '#374151' } }
                    }
                }
            });
        }
    }

    // Expose needed functions to global scope for HTML event handlers
    window.changeTimeframe = changeTimeframe;
    window.fetchData = fetchData;

    // Initialize
    fetchData();
    setInterval(fetchData, 120000);
})();
    </script>
</body>
</html>
